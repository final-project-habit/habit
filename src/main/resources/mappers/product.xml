<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- product.xml -->

<mapper namespace="product">

    <!-- 선택한 카테고리 전체 리스트 출력   -->
    <select id="list" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cate a
                 JOIN cont b ON a.cate_no = b.cate_no
        WHERE  cate_large = #{cate_large}
    </select>

    <!--  리스트와 리뷰 연결고리  -->
    <select id="contNoList" resultType="int" parameterType="String">
        SELECT b.cont_no
        FROM cate a
                 JOIN cont b ON a.cate_no = b.cate_no
        WHERE cate_large = #{cate_large}
    </select>

    <!--    아이템 리스트 리뷰 출력 -->
    <select id="star" resultType="java.util.Map" parameterType="int">
        SELECT round(avg(review_star),0) as avg_star, count(*) as cnt
        FROM review a
                 JOIN cont b ON a.cont_no = b.cont_no
        WHERE a.cont_no = #{cont_no}
    </select>

    <!--    아이템 리스트 가격 출력-->
    <select id="price" resultType="java.util.Map" parameterType="int">
        SELECT min(one_price) as money
        FROM (SELECT * FROM one
              UNION
              SELECT * FROM prod) a
                 JOIN cont c
                      ON a.cont_no = c.cont_no
                 JOIN cate ct
                      ON c.cate_no = ct.cate_no
        WHERE  a.cont_no = #{cont_no}
    </select>

    <!-- DB 등록 된 카테고리  출력   -->
    <select id="category" resultType="java.util.Map">
        SELECT cate_large
        FROM cate
        GROUP BY cate_large
    </select>


    <!-- 선택한 상품 상세페이지 이동    -->
    <select id="detail" resultType="java.util.Map" parameterType="int">
        SELECT *
        FROM cont
        WHERE cont_no = #{cont_no}
    </select>

<!--    아이템 클릭시 조회수 증가-->
    <update id="updateViewCount" parameterType="int">
        UPDATE cont
        SET cont_view = cont_view + 1
        WHERE cont_no = #{cont_no}
    </update>

    <!-- 요약 페이지 -> 인기 (상위 4개) -->
    <select id="hotTop" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large}
        ORDER BY a.cont_view DESC
            LIMIT 4
    </select>

    <!-- 인기 페이지 전체 -->
    <select id="hotList" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large}
        ORDER BY a.cont_view DESC
    </select>

    <!-- 인기&전체 페이지 개수 -->
    <select id="hotListCount" resultType="int" parameterType="String">
        SELECT count(*) as cnt
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large}
    </select>

    <!-- 신규 페이지 전체 (모두 출력 안함) -->
    <select id="newList" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large}
        ORDER BY cont_stdate DESC
            LIMIT 10
    </select>

    <!-- 요약 페이지 -> 신규 (상위 4개) -->
    <select id="newTop" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large}
        ORDER BY cont_stdate DESC
            LIMIT 4
    </select>

    <!-- 신규 페이지 개수 -->
    <select id="newListCount" resultType="int" parameterType="String">
        SELECT count(*) as cnt
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large}
        ORDER BY cont_stdate DESC
            LIMIT 10
    </select>


<!--    =========== 중분류 ===========-->

    <!--   중분류 필터 출력-->
    <select id="middle" resultType="java.util.Map" parameterType="String">
        SELECT cate_large, cate_middle
        FROM cate
        WHERE  cate_large = #{cate_large}
    </select>

    <!-- 중분류 전체보기  필터   -->
    <select id="midFilter" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cate a
                 JOIN cont b ON a.cate_no = b.cate_no
        WHERE  a.cate_large = #{cate_large} AND a.cate_middle = #{cate_middle}
    </select>

    <!-- 요약 페이지 -> 인기 (상위 4개) -->
    <select id="midHotTop" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large} AND b.cate_middle = #{cate_middle}
        ORDER BY a.cont_view DESC
            LIMIT 4
    </select>

    <!-- 인기 페이지 전체 -->
    <select id="midHotList" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large} AND b.cate_middle = #{cate_middle}
        ORDER BY a.cont_view DESC
    </select>

    <!-- 인기&전체 페이지 개수 -->
    <select id="midHotListCount" resultType="int" parameterType="String">
        SELECT count(*) as cnt
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large} AND b.cate_middle = #{cate_middle}
    </select>

    <!-- 신규 페이지 전체 (모두 출력 안함) -->
    <select id="midNewList" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large} AND b.cate_middle = #{cate_middle}
        ORDER BY cont_stdate DESC
            LIMIT 10
    </select>

    <!-- 요약 페이지 -> 신규 (상위 4개) -->
    <select id="midNewTop" resultType="java.util.Map" parameterType="String">
        SELECT *
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large} AND b.cate_middle = #{cate_middle}
        ORDER BY cont_stdate DESC
            LIMIT 4
    </select>

    <!-- 신규 페이지 개수 -->
    <select id="midNewListCount" resultType="int" parameterType="String">
        SELECT count(*) as cnt
        FROM cont a
                 JOIN cate b ON a.cate_no = b.cate_no
        WHERE b.cate_large = #{cate_large} AND b.cate_middle = #{cate_middle}
        ORDER BY cont_stdate DESC
            LIMIT 10
    </select>

    <!--    =========== 필터  ===========-->

    <select id="selectContentsByPopularity" resultType="java.util.Map" parameterType="String">
        SELECT cont.*, cate.*
        FROM cont
                 JOIN cate ON cont.cate_no = cate.cate_no
        WHERE cate.cate_large = #{cate_large}
        ORDER BY cont.cont_view DESC
    </select>

    <select id="selectContentsByDate" resultType="java.util.Map" parameterType="String">
        SELECT cont.*, cate.*
        FROM cont
                 JOIN cate ON cont.cate_no = cate.cate_no
        WHERE cate.cate_large = #{cate_large}
        ORDER BY cont.cont_stdate DESC
    </select>

    <select id="selectContentsByRating" resultType="java.util.Map" parameterType="String">
        SELECT cont.*, cate.*, IFNULL(AVG(review.review_star), 0) AS average_star
        FROM cont
                 JOIN cate ON cont.cate_no = cate.cate_no
                 LEFT JOIN review ON cont.cont_no = review.cont_no
        WHERE cate.cate_large = #{cate_large}
        GROUP BY cont.cont_no
        ORDER BY average_star DESC
    </select>

    <select id="selectContentsByHighPrice" resultType="java.util.Map" parameterType="String">
        SELECT temp.* , MIN(price) AS representative_price
        FROM (
                 SELECT cont.*, cate.cate_large, one.one_price AS price
                 FROM cont
                          JOIN cate ON cont.cate_no = cate.cate_no
                          JOIN one ON cont.cont_no = one.cont_no
                 WHERE cate.cate_large = #{cate_large}

                 UNION ALL

                 SELECT cont.*, cate.cate_large, prod.prod_price AS price
                 FROM cont
                          JOIN cate ON cont.cate_no = cate.cate_no
                          JOIN prod ON cont.cont_no = prod.cont_no
                 WHERE cate.cate_large = #{cate_large}
             ) AS temp
        GROUP BY temp.cont_no
        ORDER BY representative_price DESC
    </select>

    <select id="selectContentsByLowPrice" resultType="java.util.Map" parameterType="String">
        SELECT temp.* , MIN(price) AS representative_price
        FROM (
                 SELECT cont.*, cate.cate_large, one.one_price AS price
                 FROM cont
                          JOIN cate ON cont.cate_no = cate.cate_no
                          JOIN one ON cont.cont_no = one.cont_no
                 WHERE cate.cate_large = #{cate_large}

                 UNION ALL

                 SELECT cont.*, cate.cate_large, prod.prod_price AS price
                 FROM cont
                          JOIN cate ON cont.cate_no = cate.cate_no
                          JOIN prod ON cont.cont_no = prod.cont_no
                 WHERE cate.cate_large = #{cate_large}
             ) AS temp
        GROUP BY temp.cont_no
        ORDER BY representative_price ASC
    </select>

    <!--    =========== 중분류 필터  ===========-->

    <select id="selectMidByPopularity" resultType="java.util.Map" parameterType="String">
        SELECT cont.*, cate.*
        FROM cont
                 JOIN cate ON cont.cate_no = cate.cate_no
        WHERE cate.cate_large = #{cate_large} AND cate.cate_middle = #{cate_middle}
        ORDER BY cont.cont_view DESC
    </select>

    <select id="selectMidByDate" resultType="java.util.Map" parameterType="String">
        SELECT cont.*, cate.*
        FROM cont
                 JOIN cate ON cont.cate_no = cate.cate_no
        WHERE cate.cate_large = #{cate_large} AND cate.cate_middle = #{cate_middle}
        ORDER BY cont.cont_stdate DESC
    </select>

    <select id="selectMidByRating" resultType="java.util.Map" parameterType="String">
        SELECT cont.*, cate.*, IFNULL(AVG(review.review_star), 0) AS average_star
        FROM cont
                 JOIN cate ON cont.cate_no = cate.cate_no
                 LEFT JOIN review ON cont.cont_no = review.cont_no
        WHERE cate.cate_large = #{cate_large} AND cate.cate_middle = #{cate_middle}
        GROUP BY cont.cont_no
        ORDER BY average_star DESC
    </select>

    <select id="selectMidByHighPrice" resultType="java.util.Map" parameterType="String">
        SELECT temp.* , MIN(price) AS representative_price
        FROM (
                 SELECT cont.*, cate.cate_large, one.one_price AS price
                 FROM cont
                          JOIN cate ON cont.cate_no = cate.cate_no
                          JOIN one ON cont.cont_no = one.cont_no
                 WHERE cate.cate_large = #{cate_large} AND cate.cate_middle = #{cate_middle}

                 UNION ALL

                 SELECT cont.*, cate.cate_large, prod.prod_price AS price
                 FROM cont
                          JOIN cate ON cont.cate_no = cate.cate_no
                          JOIN prod ON cont.cont_no = prod.cont_no
                 WHERE cate.cate_large = #{cate_large} AND cate.cate_middle = #{cate_middle}
             ) AS temp
        GROUP BY temp.cont_no
        ORDER BY representative_price DESC
    </select>

    <select id="selectMidByLowPrice" resultType="java.util.Map" parameterType="String">
        SELECT temp.* , MIN(price) AS representative_price
        FROM (
                 SELECT cont.*, cate.cate_large, one.one_price AS price
                 FROM cont
                          JOIN cate ON cont.cate_no = cate.cate_no
                          JOIN one ON cont.cont_no = one.cont_no
                 WHERE cate.cate_large = #{cate_large} AND cate.cate_middle = #{cate_middle}

                 UNION ALL

                 SELECT cont.*, cate.cate_large, prod.prod_price AS price
                 FROM cont
                          JOIN cate ON cont.cate_no = cate.cate_no
                          JOIN prod ON cont.cont_no = prod.cont_no
                 WHERE cate.cate_large = #{cate_large} AND cate.cate_middle = #{cate_middle}
             ) AS temp
        GROUP BY temp.cont_no
        ORDER BY representative_price ASC
    </select>

</mapper>